---
import { Icon } from 'astro-icon/components';
---

<section class="bg-[#2E3440] py-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <h2 class="text-3xl font-bold text-[#E5E9F0] mb-12">Dashboard / Highlights</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Currently Based In - Interactive Map -->
      <div class="bg-[#3B4252] border border-[#434C5E] rounded-lg p-6 hover:border-[#88C0D0] transition-colors duration-200 lg:col-span-2 lg:row-span-2 overflow-hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-[#E5E9F0]">Currently Based In</h3>
          <span class="text-2xl">üìç</span>
        </div>

        <!-- Interactive Leaflet Map -->
        <div id="mapContainer" class="mb-4 rounded-lg overflow-hidden border border-[#434C5E] h-100 bg-[#2E3440]" style="position: relative;"></div>

        <div class="flex items-baseline gap-2 mb-2">
          <p class="text-[#D8DEE9] font-medium">Toronto, ON</p>
          <p class="text-[#88C0D0] text-lg font-bold" id="currentTime">--:--:-- AM</p>
        </div>
      </div>

      <!-- Recent Commits -->
      <div class="bg-[#3B4252] border border-[#434C5E] rounded-lg p-6 hover:border-[#88C0D0] transition-colors duration-200 lg:col-span-2">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base font-semibold text-[#E5E9F0]">Recent Commits</h3>
          <a href="https://github.com/penqguin" target="_blank" rel="noopener noreferrer" class="text-[#88C0D0] hover:text-[#81A1C1] transition-colors">
            <Icon name="mdi:github" class="w-4 h-4" />
          </a>
        </div>

        <div id="commitsList" class="space-y-3 text-xs max-h-48 overflow-y-auto">
          <p class="text-[#88C0D0]">Loading commits...</p>
        </div>

        <!-- Language Distribution Bar (client-rendered) -->
        <div id="languageBarContainer" class="mt-4 pt-3 border-t border-[#434C5E] hidden">
          <div id="languageBar" class="flex gap-0.5 h-1 rounded overflow-hidden"></div>
          <div id="languageLegend" class="flex gap-2 mt-2 flex-wrap text-xs"></div>
        </div>

        <a href="https://github.com/penqguin" target="_blank" rel="noopener noreferrer" class="text-[#88C0D0] hover:text-[#81A1C1] text-xs mt-3 inline-block">
          View on GitHub ‚Üí
        </a>
      </div>

      <!-- Tic Tac Toe - Square Widget -->
      <div class="bg-[#3B4252] border border-[#434C5E] rounded-lg p-4 hover:border-[#88C0D0] transition-colors duration-200 flex flex-col items-center justify-center">
        <div class="mb-3 text-center">
          <p class="text-sm font-semibold text-[#E5E9F0]">Tic Tac Toe</p>
          <p class="text-2xl font-bold text-[#88C0D0]" id="winCount">0</p>
          <p class="text-[#D8DEE9] text-xs">wins</p>
        </div>

        <!-- Compact Game Board -->
        <div class="grid grid-cols-3 gap-1 bg-[#2E3440] p-1 rounded mb-3" id="gameBoard">
          {[...Array(9)].map((_, i) => (
            <button
              class="w-10 h-10 bg-[#434C5E] border border-[#5E81AC] rounded text-sm font-bold text-[#E5E9F0] hover:bg-[#5E81AC] transition-colors duration-200"
              data-index={i}
            ></button>
          ))}
        </div>

        <p class="text-[#88C0D0] text-xs text-center mb-3 h-4" id="gameStatus">Your turn</p>

        <button
          id="resetBtn"
          class="px-3 py-1 bg-[#88C0D0] text-[#2E3440] rounded text-xs font-semibold hover:bg-[#81A1C1] transition-colors duration-200 w-full"
        >
          New Game
        </button>
      </div>

      <!-- Contact Me Widget -->
      <div class="bg-[#3B4252] border border-[#434C5E] rounded-lg p-6 hover:border-[#88C0D0] transition-colors duration-200 flex flex-col items-center justify-center">
        <div class="text-center mb-4">
          <p class="text-lg font-semibold text-[#E5E9F0] mb-2">Contact Me</p>
          <p class="text-[#D8DEE9] text-xs mb-4">Always happy to talk about interesting topics.</p>
        </div>

        <form id="contactForm" class="w-full space-y-3" netlify>
          <input
            type="email"
            name="email"
            placeholder="Your email"
            required
            class="w-full px-3 py-2 bg-[#2E3440] border border-[#434C5E] rounded text-[#D8DEE9] text-xs placeholder-[#88C0D0] focus:outline-none focus:border-[#88C0D0] transition-colors"
          />
          <textarea
            name="message"
            placeholder="Your message"
            required
            rows="3"
            class="w-full px-3 py-2 bg-[#2E3440] border border-[#434C5E] rounded text-[#D8DEE9] text-xs placeholder-[#88C0D0] focus:outline-none focus:border-[#88C0D0] transition-colors resize-none"
          ></textarea>
          <button
            type="submit"
            class="w-full px-3 py-2 bg-[#88C0D0] text-[#2E3440] rounded text-xs font-semibold hover:bg-[#81A1C1] transition-colors duration-200"
          >
            Send Email
          </button>
        </form>

        <p id="contactStatus" class="text-[#88C0D0] text-xs mt-2 h-4"></p>
      </div>
    </div>
  </div>
</section>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script is:inline>
// Client-side logic: map, commits fetch, language bar, tic-tac-toe
(function () {
  // Map init
  function initMap() {
    const mapContainer = document.getElementById('mapContainer');
    if (!mapContainer || !window.L) {
      setTimeout(initMap, 100);
      return;
    }

    const map = L.map(mapContainer, {
      scrollWheelZoom: true,
      dragging: true,
      touchZoom: true,
      zoomControl: false,
    }).setView([43.6532, -79.3832], 11);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      maxZoom: 19,
    }).addTo(map);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }

  // Time
  function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    const timeEl = document.getElementById('currentTime');
    if (timeEl) timeEl.textContent = timeString;
  }
  updateTime();
  setInterval(updateTime, 1000);

  // Commits + language bar (client-side)
  const languageColors = {
    'TypeScript': '#3178C6', 'JavaScript': '#F7DF1E', 'Python': '#3776AB', 'Astro': '#FF5D01',
    'CSS': '#563D7C', 'HTML': '#E34C26', 'Java': '#007396', 'Rust': '#CE422B', 'Go': '#00ADD8', 'Ruby': '#CC342D'
  };

  async function loadCommitsAndLanguages() {
    const commitsListEl = document.getElementById('commitsList');
    const barContainer = document.getElementById('languageBarContainer');
    const barEl = document.getElementById('languageBar');
    const legendEl = document.getElementById('languageLegend');

    commitsListEl.innerHTML = '<p class="text-[#88C0D0]">Loading recent activity...</p>';

    try {
      // Use public events API ‚Äî single request instead of per-repo fetches
      // This endpoint returns recent activity including push events with commit info
      const eventsResp = await fetch('https://api.github.com/users/Penqguin/events/public?per_page=30');
      if (!eventsResp.ok) throw new Error(`HTTP ${eventsResp.status}`);

      const events = await eventsResp.json();
      const commits = [];
      const repoLanguages = {};

      // Extract PushEvent commits and collect language info
      for (const event of events) {
        if (event.type === 'PushEvent' && event.payload?.commits) {
          const repo = event.repo.name;
          for (const commit of event.payload.commits) {
            commits.push({
              sha: commit.sha,
              message: commit.message,
              repo: repo,
              date: event.created_at,
              url: `https://github.com/${event.repo.name}/commit/${commit.sha}`,
            });
          }
          // Track repo for language hints (optional secondary fetch)
          if (!repoLanguages[repo]) {
            repoLanguages[repo] = 'Unknown';
          }
        }
      }

      if (commits.length === 0) {
        commitsListEl.innerHTML = '<p class="text-[#88C0D0]">No recent commits found.</p>';
        return;
      }

      // Sort by date descending and take top 10 for language stats
      commits.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
      const top10 = commits.slice(0, 10);
      const top3 = commits.slice(0, 3);

      // Render top 3 commits
      commitsListEl.innerHTML = '';
      for (const commit of top3) {
        const msg = commit.message.split('\n')[0];
        const sha = commit.sha.substring(0, 7);
        const a = document.createElement('a');
        a.href = commit.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'block hover:text-[#88C0D0] transition-colors border-l-2 border-[#88C0D0] pl-3 py-1';

        const p1 = document.createElement('p');
        p1.className = 'text-[#D8DEE9] hover:underline font-medium';
        p1.textContent = `${commit.repo}: ${msg.substring(0, 40)}`;

        const p2 = document.createElement('p');
        p2.className = 'text-[#88C0D0] text-xs';
        p2.textContent = sha;

        a.appendChild(p1);
        a.appendChild(p2);
        commitsListEl.appendChild(a);
      }

      // Compute language stats from top10 repos
      const langStats = {};
      for (const commit of top10) {
        const lang = repoLanguages[commit.repo] || 'Other';
        langStats[lang] = (langStats[lang] || 0) + 1;
      }

      // Render language bar
      const sorted = Object.entries(langStats).sort((a, b) => b[1] - a[1]);
      if (sorted.length > 0) {
        barEl.innerHTML = '';
        legendEl.innerHTML = '';
        const total = top10.length || 1;
        for (const [lang, count] of sorted) {
          const color = languageColors[lang] || '#88C0D0';
          const pct = (count / total) * 100;
          const seg = document.createElement('div');
          seg.className = 'h-full';
          seg.style.width = pct + '%';
          seg.style.backgroundColor = color;
          seg.title = `${lang}: ${count} commits`;
          barEl.appendChild(seg);

          const legendItem = document.createElement('div');
          legendItem.className = 'flex items-center gap-1';
          const dot = document.createElement('div');
          dot.className = 'w-2 h-2 rounded-full';
          dot.style.backgroundColor = color;
          const label = document.createElement('span');
          label.className = 'text-[#D8DEE9]';
          label.textContent = lang;
          legendItem.appendChild(dot);
          legendItem.appendChild(label);
          legendEl.appendChild(legendItem);
        }
        barContainer.classList.remove('hidden');
      }
    } catch (err) {
      console.error('Failed to load commits:', err);
      commitsListEl.innerHTML = '<p class="text-[#88C0D0]">Unable to load recent commits.</p>';
    }
  }

  // start loading commits after DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadCommitsAndLanguages);
  } else {
    loadCommitsAndLanguages();
  }

  // Tic-tac-toe logic (kept client-side)
  let board = ['', '', '', '', '', '', '', '', ''];
  let gameActive = true;
  let isPlayerTurn = true;

  const gameBoard = document.getElementById('gameBoard');
  const gameStatus = document.getElementById('gameStatus');
  const resetBtn = document.getElementById('resetBtn');
  const winCountEl = document.getElementById('winCount');

  const winConditions = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

  function getWinCount(){ const wins = localStorage.getItem('tictactoe_wins'); return wins?parseInt(wins):0; }
  function setWinCount(c){ localStorage.setItem('tictactoe_wins', c.toString()); winCountEl.textContent = c; }
  function checkWin(p){ return winConditions.some(cond => cond.every(i => board[i]===p)); }
  function getAvailableMoves(){ return board.map((cell, i)=> cell===''?i:null).filter(i=>i!==null); }

  function botMove(){
    const available = getAvailableMoves(); if(available.length===0) return;
    for(let move of available){ board[move]='O'; if(checkWin('O')){ updateBoard(); gameStatus.textContent='Bot wins! ü§ñ'; gameActive=false; return;} board[move]=''; }
    for(let move of available){ board[move]='X'; if(checkWin('X')){ board[move]='O'; updateBoard(); gameStatus.textContent='Your turn'; isPlayerTurn=true; return;} board[move]=''; }
    if(available.includes(4)) board[4]='O'; else if(available.some(i=>[0,2,6,8].includes(i))){ const corners=available.filter(i=>[0,2,6,8].includes(i)); board[corners[Math.floor(Math.random()*corners.length)]]='O'; } else { board[available[Math.floor(Math.random()*available.length)]]='O'; }
    updateBoard(); isPlayerTurn=true; gameStatus.textContent='Your turn';
  }

  function updateBoard(){ const buttons = gameBoard.querySelectorAll('button'); buttons.forEach((btn,i)=>{ btn.textContent = board[i]; btn.disabled = board[i] !== ''; }); }
  function resetGame(){ board = ['', '', '', '', '', '', '', '', '']; gameActive=true; isPlayerTurn=true; gameStatus.textContent='Your turn'; updateBoard(); }

  gameBoard.addEventListener('click', (e)=>{
    if(!gameActive||!isPlayerTurn) return; const btn = e.target.closest('button'); if(!btn||btn===resetBtn) return; const index = Array.from(gameBoard.querySelectorAll('button')).indexOf(btn); if(board[index]!== '') return; board[index]='X'; updateBoard(); if(checkWin('X')){ gameStatus.textContent='You win! üéâ'; setWinCount(getWinCount()+1); gameActive=false; return; } if(getAvailableMoves().length===0){ gameStatus.textContent='Draw! ü§ù'; gameActive=false; return;} isPlayerTurn=false; gameStatus.textContent='Bot...'; setTimeout(botMove, 500);
  });

  resetBtn.addEventListener('click', resetGame);
  winCountEl.textContent = getWinCount().toString();

  // Contact form handler
  const contactForm = document.getElementById('contactForm');
  const contactStatus = document.getElementById('contactStatus');

  if (contactForm) {
    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = contactForm.querySelector('input[name="email"]').value;
      const message = contactForm.querySelector('textarea[name="message"]').value;
      const submitBtn = contactForm.querySelector('button[type="submit"]');

      // Disable submit button and show status
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      contactStatus.textContent = 'Sending...';
      contactStatus.className = 'text-[#88C0D0] text-xs mt-2 h-4';

      try {
        // Send via Formspree
        const response = await fetch('https://formspree.io/f/mzbnlrrk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, message }),
        });

        if (response.ok) {
          contactStatus.textContent = 'Email sent! üéâ';
          contactStatus.className = 'text-[#A3BE8C] text-xs mt-2 h-4';
          contactForm.reset();
          submitBtn.textContent = 'Send Email';
          submitBtn.disabled = false;
        } else {
          throw new Error('Failed to send');
        }
      } catch (err) {
        contactStatus.textContent = 'Error sending. Try again.';
        contactStatus.className = 'text-[#BF616A] text-xs mt-2 h-4';
        console.error('Contact form error:', err);
        submitBtn.textContent = 'Send Email';
        submitBtn.disabled = false;
      }
    });
  }

})();
</script>
